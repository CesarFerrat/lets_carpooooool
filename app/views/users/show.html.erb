<br>
<br>
<br>
<body class="parallax">
<%=@title%>

<a href="/" class="btn btn-primary">Profile</a>
<a href="/users/<%=current_user.id%>/showtrips" class="btn btn-primary">Trips</a>
<a href="/" class="btn btn-primary">Post a new trip</a>
<a href="/" class="btn btn-primary">Reservations</a>
<a href="/" class="btn btn-primary">Wallet</a>
<a href="/" class="btn btn-primary">Settings</a>

 		<div class="modal fade scroll" id="loading-indicator" background="transparent" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-body">
              <div id="display_ajax"> Loading Trip details, Thanks for your patience !
                <%= image_tag("ajax-loader.gif", :id => "loading-indicator") %>
              </div>
              <div id="map-canvas">
              </div>
            </div>
          </div>
        </div>
      </div>
</div>

<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?libraries=places"></script>
<script type="text/javascript" src="http://google-maps-utility-library-v3.googlecode.com/svn/trunk/routeboxer/src/RouteBoxer.js"></script>
<style type="text/css">
      #map-canvas{
          height: 300px;
          width: 350px;
      }
    </style>
<script>
$(document).ready(addTrip);

function addTrip () {

    if (sessionStorage.length > 0) {

      var saved_new_trip = JSON.parse(window.sessionStorage.getItem("new-trip"));

      var request = $.post('/users/<%=current_user.id%>/trips', saved_new_trip);

                       function onSaveSuccess (response) {
                         console.debug('saved!', response);
                         sessionStorage.clear();
                         calcRoute(saved_new_trip, response.id);
                       }

                       function onSaveFailure (err) {
                         console.error(err.responseJSON);
                       }

                       request.done(onSaveSuccess);
                       request.fail(onSaveFailure);

    }else {
        console.debug('No trip added by refreshing webpage...')
    };

}


//     function storeRouteDetails(saved_new_trip, trip_id){

//         $('#loading-indicator').modal('toggle');
//         console.log("start storing route details");
//         var directionsDisplay;
//         var directionsService = new google.maps.DirectionsService();
//         var map;
//         var routeBoxer = new RouteBoxer();
//         var placeTypes;
//         var placesService;

//         var chicago = new google.maps.LatLng(41.850033, -87.6500523);
//         var mapOptions = {
//           zoom:9,
//           center: chicago,
//         };
//         map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);

//         directionsDisplay = new google.maps.DirectionsRenderer();
//         placesService = new google.maps.places.PlacesService(map);
//         directionsDisplay.setMap(map);

//         var request = {
//             origin: new google.maps.LatLng(saved_new_trip.lat1,saved_new_trip.lng1),
//             destination: new google.maps.LatLng(saved_new_trip.lat2,saved_new_trip.lng2),
//             travelMode: google.maps.TravelMode.DRIVING
//         };

//         directionsService.route(request, function(response, status) {
//           if (status == google.maps.DirectionsStatus.OK) {
//             directionsDisplay.setDirections(response);
//             createRouteBoxes(response.routes[0].overview_path);
//             var distance = response.routes[0].legs[0].distance['text'];
//             // $('#distance').html(distanceTemplate({distance: distance}));

//           }else {
//               console.warn(status);
//           }
//         });

//         function createRouteBoxes(overview_path) {
//           var boxes = routeBoxer.box(overview_path, 3);
//           console.log("route-boxing");
//           var count = boxes.length
//           getNearbyPlaces(boxes, count);
//         };

//         function getNearbyPlaces(boxes, howManyTimes) {

//             if (howManyTimes === 0) {
//               console.log('done searching for places');
//               $('#loading-indicator').modal('toggle');

//             }
//             for (var counter = howManyTimes; howManyTimes > 0; howManyTimes--){
//               console.log(counter)
//               var opts = {
//                 bounds: boxes[counter],
//                 types: ['local_government_office']
//               };
//               placesService.nearbySearch(opts, function(results, status) {

//                 if (status === google.maps.places.PlacesServiceStatus.OK) {
//                   getTown(results);
//                 } else if (status === google.maps.places.PlacesServiceStatus.OVER_QUERY_LIMIT) {
//                   console.log('Over query limit; waiting 1 second');
//                   setTimeout(function() {
//                     getNearbyPlaces(boxes, counter);
//                   }, 2000);
//                 } else {
//                   console.log('ERROR: ' + status);
//                   getNearbyPlaces(boxes, counter-1);
//                 }
//               });


//           function getTown(results){

//             var list_stops = [];

//             for (var i = 0; i < results.length; i++) {
//               console.log(results[i])
//               var id = results[i].place_id;

//               var request = {placeId: id};

//               placesService.getDetails(request, callback);


//                   function callback(place, status) {
//                     if (status == google.maps.places.PlacesServiceStatus.OK) {
//                       var city_address = place.formatted_address.split(", ");
//                       console.log(city_address);
//                       list_stops.concat(city_address);
//                     }
//                   }
//             } var request = $.ajax({
//                                   url: '/trips/add_coords/' + trip_id ,
//                                   type: 'PATCH',
//                                   data: {
//                                           list_stops: list_stops
//                                         },
//               });

//             request.done(getNearbyPlaces(boxes, counter));
//           };
//     };
//   }


// }





function calcRoute(saved_new_trip, trip_id) {
  var directionsDisplay;
  var directionsService = new google.maps.DirectionsService();
  var map;
  var routeBoxer = new RouteBoxer();
  var placeTypes;
  var placesService;
  $('#loading-indicator').modal('toggle');
  directionsDisplay = new google.maps.DirectionsRenderer();
  var chicago = new google.maps.LatLng(41.850033, -87.6500523);
  var mapOptions = {
    zoom:2,
    center: chicago,
  };
  map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
  placesService = new google.maps.places.PlacesService(map);
  directionsDisplay.setMap(map);

  var request = {
      origin: new google.maps.LatLng(saved_new_trip.lat1,saved_new_trip.lng1),
      destination: new google.maps.LatLng(saved_new_trip.lat2,saved_new_trip.lng2),
      travelMode: google.maps.TravelMode.DRIVING
  };

  directionsService.route(request, function(response, status) {
    if (status == google.maps.DirectionsStatus.OK) {
      directionsDisplay.setDirections(response);
      createRouteBoxes(response.routes[0].overview_path);
      var distance = response.routes[0].legs[0].distance['text'];
      // $('#distance').html(distanceTemplate({distance: distance}));

    }else {
        console.warn(status);
    }
  });

  function createRouteBoxes(overview_path) {
    var boxes = routeBoxer.box(overview_path, 3);
    // find places in each box
    getNearbyPlaces(boxes, 0);
  };

  function getNearbyPlaces(boxes, i) {
    if (i === boxes.length) {
      console.log('done searching for places');
      $('#loading-indicator').modal('toggle');
      return;
    }
    var opts = {
      bounds: boxes[i],
      types: ['local_government_office']
    };


    placesService.nearbySearch(opts, function(results, status) {

      if (status === google.maps.places.PlacesServiceStatus.OK) {
        getTown(results);
        getNearbyPlaces(boxes, i+1);
      } else if (status === google.maps.places.PlacesServiceStatus.OVER_QUERY_LIMIT) {
        console.log('Over query limit; waiting 1 second');
        setTimeout(function() {
          getNearbyPlaces(boxes, i);
        }, 1000);
      } else {
        console.log('ERROR: ' + status);
        getNearbyPlaces(boxes, i+1);
      }
    });
  }

  function getTown(results){
    var trips_all_arr = []
    for (var i = 0; i < results.length; i++) {
      var id = results[i].place_id;

      var request = {placeId: id};
      placesService.getDetails(request, callback);

      function callback(place, status) {
        if (status == google.maps.places.PlacesServiceStatus.OK) {
          var city = place.formatted_address;
          console.log(city);
          hittingdatabase();
            function hittingdatabase(){
            $.ajax({
                url: '/trips/add_coords/' + trip_id ,
                type: 'PATCH',
                data: {
                  city: city
                },
                 success: function(all_trips){
                 console.log(all_trips);
                 trips_all_arr.push(all_trips);

                  }
              });
          }
        }
      }
    }
  };
}



</script>
